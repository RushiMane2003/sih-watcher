name: Watch SIH page (TEST)

on:
  schedule:
    - cron: '*/5 * * * *'   # every 5 minutes for testing
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check-page:
    runs-on: ubuntu-latest
    env:
      TARGET_URL: "https://httpbin.org/uuid"   # test URL that always changes
      SNAPSHOT_FILE: "snapshot.html"
      CURRENT_FILE: "current.html"
      HASH_FILE: "snapshot.sha256"
      CURRENT_HASH_FILE: "current.sha256"

    steps:
      - name: Checkout branch (not detached)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0
          persist-credentials: true

      - name: Debug repo state
        run: |
          echo "ref:       ${{ github.ref }}"
          echo "ref_name:  ${{ github.ref_name }}"
          git status
          git branch -vv
          git remote -v

      - name: Fetch page
        run: |
          echo "Fetching: $TARGET_URL"
          curl -L -sS "$TARGET_URL" -o "$CURRENT_FILE"
          tr -s '[:space:]' ' ' < "$CURRENT_FILE" > tmp && mv tmp "$CURRENT_FILE"
          sha256sum "$CURRENT_FILE" | cut -d' ' -f1 > "$CURRENT_HASH_FILE"
          echo "Current hash: $(cat $CURRENT_HASH_FILE)"

      - name: First run? Initialize snapshot if missing (no alert yet)
        id: init
        run: |
          if [ ! -f "$SNAPSHOT_FILE" ]; then
            echo "No snapshot found. Initializing baseline."
            cp "$CURRENT_FILE" "$SNAPSHOT_FILE"
            cp "$CURRENT_HASH_FILE" "$HASH_FILE"
            echo "first_run=true" >> $GITHUB_OUTPUT
          else
            echo "Snapshot exists."
            echo "first_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit baseline snapshot (first run only)
        if: steps.init.outputs.first_run == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$SNAPSHOT_FILE" "$HASH_FILE"
          git commit -m "Baseline snapshot: $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}

      - name: Compare with previous
        id: diff
        if: steps.init.outputs.first_run == 'false'
        run: |
          echo "Previous hash: $(cat $HASH_FILE || true)"
          echo "Current  hash: $(cat $CURRENT_HASH_FILE)"
          if cmp -s "$CURRENT_HASH_FILE" "$HASH_FILE"; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No change."
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Change detected."
          fi

      - name: Commit updated snapshot (only if changed)
        if: steps.diff.outputs.changed == 'true'
        run: |
          mv "$CURRENT_FILE" "$SNAPSHOT_FILE"
          mv "$CURRENT_HASH_FILE" "$HASH_FILE"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$SNAPSHOT_FILE" "$HASH_FILE"
          git commit -m "Snapshot updated: $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git push origin HEAD:${{ github.ref_name }}

      - name: Open a GitHub Issue notification (only if changed)
        if: steps.diff.outputs.changed == 'true'
        run: |
          TITLE="Watched page changed"
          BODY=$'The watched page changed.\n\nURL: '"$TARGET_URL"$'\nTime (UTC): '"$(date -u +'%Y-%m-%d %H:%M:%S')"
          API="https://api.github.com/repos/${{ github.repository }}/issues"
          echo "{\"title\":\"$TITLE\",\"body\":\"$BODY\"}" > issue.json
          curl -sS -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "$API" -d @issue.json
