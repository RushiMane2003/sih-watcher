name: Watch SIH page (PLAYWRIGHT)

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  check-page:
    runs-on: ubuntu-latest
    env:
      # Use the REAL SIH URL here (no proxy)
      TARGET_URL: "https://sih.gov.in/"
      SNAPSHOT_FILE: "snapshot.html"
      CURRENT_FILE: "current.html"
      HASH_FILE: "snapshot.sha256"
      CURRENT_HASH_FILE: "current.sha256"

    steps:
      - name: Checkout repo (pushable)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Ensure 'snapshots' branch and switch to it FIRST
        run: |
          set -euxo pipefail
          if git ls-remote --exit-code --heads origin snapshots >/dev/null 2>&1; then
            git fetch origin snapshots:refs/heads/snapshots
          fi
          if git show-ref --verify --quiet refs/heads/snapshots; then
            git switch snapshots
          else
            git switch -c snapshots
          fi
          echo "On branch: $(git branch --show-current)"

      - name: Install Playwright Chromium
        run: |
          set -euxo pipefail
          npm init -y
          npm i playwright@1
          npx playwright install --with-deps chromium

      - name: Render page with Playwright and save HTML
        run: |
          set -euxo pipefail
          cat > fetch.js <<'EOF'
          const fs = require('fs');
          const { chromium } = require('playwright');
          (async () => {
            const browser = await chromium.launch({ headless: true });
            const context = await browser.newContext({
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120 Safari/537.36',
              viewport: { width: 1366, height: 768 }
            });
            const page = await context.newPage();
            const url = process.env.TARGET_URL;
            await page.route('**/*', (route) => {
              const headers = {
                ...route.request().headers(),
                'Accept-Language': 'en-US,en;q=0.9'
              };
              route.continue({ headers });
            });
            await page.goto(url, { waitUntil: 'networkidle', timeout: 60000 });
            // If there's a specific results selector, wait for it (optional):
            // await page.waitForSelector('#results-panel', { timeout: 30000 });
            const html = await page.content();
            fs.writeFileSync(process.env.CURRENT_FILE, html, 'utf8');
            await browser.close();
          })();
          EOF
          node fetch.js
          echo "----- current.html preview (first 200 chars) -----"
          head -c 200 "$CURRENT_FILE" || true; echo
          tr -s '[:space:]' ' ' < "$CURRENT_FILE" > tmp && mv tmp "$CURRENT_FILE"
          sha256sum "$CURRENT_FILE" | cut -d' ' -f1 > "$CURRENT_HASH_FILE"
          echo "Current SHA256: $(cat "$CURRENT_HASH_FILE")"

      - name: First run? Initialize snapshot if missing
        id: init
        run: |
          set -euxo pipefail
          if [ ! -f "$SNAPSHOT_FILE" ]; then
            cp "$CURRENT_FILE" "$SNAPSHOT_FILE"
            cp "$CURRENT_HASH_FILE" "$HASH_FILE"
            echo "first_run=true" >> $GITHUB_OUTPUT
          else
            echo "first_run=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit baseline snapshot (first run only)
        if: steps.init.outputs.first_run == 'true'
        run: |
          set -euxo pipefail
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$SNAPSHOT_FILE" "$HASH_FILE"
          git commit -m "Baseline snapshot: $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git push origin HEAD:snapshots

      - name: Compare with previous (hash vs hash)
        id: diff
        if: steps.init.outputs.first_run == 'false'
        run: |
          set -euxo pipefail
          echo "Previous SHA256: $(cat "$HASH_FILE" || true)"
          echo "Current  SHA256: $(cat "$CURRENT_HASH_FILE")"
          if cmp -s "$CURRENT_HASH_FILE" "$HASH_FILE"; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit updated snapshot (only if changed)
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          mv "$CURRENT_FILE" "$SNAPSHOT_FILE"
          mv "$CURRENT_HASH_FILE" "$HASH_FILE"
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$SNAPSHOT_FILE" "$HASH_FILE"
          git commit -m "Snapshot updated: $(date -u +'%Y-%m-%d %H:%M:%S')" || echo "Nothing to commit"
          git push origin HEAD:snapshots

      - name: Open a GitHub Issue (only if changed)
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euxo pipefail
          TITLE="Watched page changed (Playwright)"
          BODY=$'The watched page changed (rendered with Playwright).\n\nURL: '"$TARGET_URL"$'\nTime (UTC): '"$(date -u +'%Y-%m-%d %H:%M:%S')"
          API="https://api.github.com/repos/${{ github.repository }}/issues"
          printf '{"title":"%s","body":"%s"}' "$TITLE" "$BODY" > issue.json
          curl -sS -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "$API" -d @issue.json

      - name: Upload artifacts (debug)
        uses: actions/upload-artifact@v4
        with:
          name: fetched-files-playwright
          path: |
            current.html
            snapshot.html
            current.sha256
            snapshot.sha256
          if-no-files-found: ignore
